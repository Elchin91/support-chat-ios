name: Build iOS IPA for TrollStore

on:
  push:
    branches: [ main, master ]
    paths:
      - 'ios app/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'ios app/**'
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Backend server IP (default: localhost)'
        required: false
        default: 'localhost'

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Update server configuration
      run: |
        if [ "${{ github.event.inputs.server_host }}" != "" ]; then
          SERVER_HOST="${{ github.event.inputs.server_host }}"
        else
          SERVER_HOST="localhost"
        fi
        echo "Using server host: $SERVER_HOST"
        
        # Update AppConfig.swift with the server host
        cd "SupportChat/SupportChat/Config"
        sed -i '' "s/localhost/$SERVER_HOST/g" AppConfig.swift
    
    - name: Build app
      run: |
        cd "SupportChat"
        
        # Create build directory
        mkdir -p build
        
        # Build without code signing
        xcodebuild \
          -project SupportChat.xcodeproj \
          -scheme SupportChat \
          -configuration Release \
          -derivedDataPath build \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          -arch arm64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          -allowProvisioningUpdates \
          clean build
    
    - name: Create IPA
      run: |
        cd "SupportChat"
        
        # Find the .app file
        APP_PATH=$(find build -name "*.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "Error: Could not find .app file"
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        
        # Create Payload directory
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Create IPA
        zip -r SupportChat-TrollStore.ipa Payload
        
        # Clean up
        rm -rf Payload
        
        echo "IPA created successfully"
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: SupportChat-TrollStore-IPA
        path: SupportChat/SupportChat-TrollStore.ipa
        retention-days: 30
    
    - name: Create Release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SupportChat/SupportChat-TrollStore.ipa
        body: |
          ## iOS приложение Support Chat для TrollStore
          
          ### Установка:
          1. Скачайте IPA файл
          2. Установите через TrollStore
          
          ### Настройка сервера:
          - По умолчанию использует localhost
          - Измените IP в настройках приложения после установки
          
          ### Требования:
          - iOS 16.0+
          - TrollStore установлен
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
