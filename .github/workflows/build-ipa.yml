name: Build iOS IPA for TrollStore

on:
  push:
    branches: [ main, master ]
    paths:
      - 'ios app/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'ios app/**'
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Backend server IP (default: localhost)'
        required: false
        default: 'localhost'

jobs:
  build:
    name: Build IPA
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Update server configuration
      run: |
        if [ "${{ github.event.inputs.server_host }}" != "" ]; then
          SERVER_HOST="${{ github.event.inputs.server_host }}"
        else
          SERVER_HOST="localhost"
        fi
        echo "Using server host: $SERVER_HOST"
        
        # Show current AppConfig.swift content
        echo "Current AppConfig.swift:"
        cat SupportChat/SupportChat/Config/AppConfig.swift | grep -A 2 "serverHost"
        
        # Update AppConfig.swift with the server host
        # Replace localhost with the provided IP (handle both quoted and unquoted)
        sed -i '' "s|\"localhost\"|\"$SERVER_HOST\"|g" SupportChat/SupportChat/Config/AppConfig.swift
        sed -i '' "s|localhost|$SERVER_HOST|g" SupportChat/SupportChat/Config/AppConfig.swift
        
        # Verify the change
        echo "Updated AppConfig.swift:"
        cat SupportChat/SupportChat/Config/AppConfig.swift | grep -A 2 "serverHost"
        
        if ! grep -q "$SERVER_HOST" SupportChat/SupportChat/Config/AppConfig.swift; then
          echo "Warning: Server host replacement may have failed"
        fi
    
    - name: Build app
      run: |
        cd "SupportChat"
        
        # Create build directory
        mkdir -p build
        
        # List available SDKs
        echo "Available SDKs:"
        xcodebuild -showsdks
        
        # Build without code signing (using arch instead of destination)
        xcodebuild \
          -project SupportChat.xcodeproj \
          -scheme SupportChat \
          -configuration Release \
          -derivedDataPath build \
          -sdk iphoneos \
          -arch arm64 \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          clean build
        
        # Verify build output
        echo "Checking build output..."
        find build -name "*.app" -type d | head -5
    
    - name: Create IPA
      run: |
        cd "SupportChat"
        
        # Find the .app file (check multiple possible locations)
        APP_PATH=$(find build -name "SupportChat.app" -type d | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "Trying alternative search..."
          APP_PATH=$(find build -name "*.app" -type d | head -n 1)
        fi
        
        if [ -z "$APP_PATH" ]; then
          echo "Error: Could not find .app file"
          echo "Build directory contents:"
          find build -type f -name "*.swiftmodule" | head -5
          find build -type d -name "*.app" 2>/dev/null || echo "No .app directories found"
          exit 1
        fi
        
        echo "Found app at: $APP_PATH"
        ls -la "$APP_PATH" | head -10
        
        # Create Payload directory
        mkdir -p Payload
        cp -r "$APP_PATH" Payload/
        
        # Create IPA
        zip -r SupportChat-TrollStore.ipa Payload
        
        # Verify IPA was created
        if [ ! -f "SupportChat-TrollStore.ipa" ]; then
          echo "Error: IPA file was not created"
          exit 1
        fi
        
        # Show IPA info
        ls -lh SupportChat-TrollStore.ipa
        
        # Clean up
        rm -rf Payload
        
        echo "IPA created successfully"
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: SupportChat-TrollStore-IPA
        path: SupportChat/SupportChat-TrollStore.ipa
        retention-days: 30
    
    - name: Create Release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: SupportChat/SupportChat-TrollStore.ipa
        body: |
          ## iOS приложение Support Chat для TrollStore
          
          ### Установка:
          1. Скачайте IPA файл
          2. Установите через TrollStore
          
          ### Настройка сервера:
          - По умолчанию использует localhost
          - Измените IP в настройках приложения после установки
          
          ### Требования:
          - iOS 16.0+
          - TrollStore установлен
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
